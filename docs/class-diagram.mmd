classDiagram
    %% ============================================
    %% HiveApp - Class Diagram
    %% ============================================

    %% ──────────────────────────────────────────
    %% SHARED PERMISSION ENGINE
    %% ──────────────────────────────────────────

    class PermissionEngine {
        <<service>>
        +resolvePermissions(actor: IPermissionActor, context: PermissionContext) PermissionSet
        +checkAccess(actor: IPermissionActor, permission: String, context: PermissionContext) Boolean
        +getEffectivePermissions(actor: IPermissionActor, context: PermissionContext) PermissionSet
        -applyCeiling(permissions: PermissionSet, ceiling: PermissionSet) PermissionSet
        -mergeRolePermissions(roles: Role[]) PermissionSet
        -resolveCollaborationCeiling(collaboration: Collaboration) PermissionSet
        -resolvePlanCeiling(subscription: Subscription) PermissionSet
    }

    class PermissionContext {
        <<valueobject>>
        +contextType: ContextType
        +tokenType: TokenType
        +accountId: UUID
        +companyId: UUID?
        +collaborationId: UUID?
        +getContextType() ContextType
        +getTokenType() TokenType
    }

    class ContextType {
        <<enumeration>>
        ADMIN_PLATFORM
        CLIENT_OWN_ACCOUNT
        CLIENT_COLLABORATION
    }

    class TokenType {
        <<enumeration>>
        CLIENT
        ADMIN
    }

    class PermissionSet {
        <<valueobject>>
        -permissions: Map~String, Permission~
        +has(permissionCode: String) Boolean
        +intersect(other: PermissionSet) PermissionSet
        +union(other: PermissionSet) PermissionSet
        +subtract(other: PermissionSet) PermissionSet
        +toList() Permission[]
        +isEmpty() Boolean
    }

    class IPermissionActor {
        <<interface>>
        +getId() UUID
        +getRoles(context: PermissionContext) Role[]
        +getPermissionCeiling(context: PermissionContext) PermissionSet
    }

    %% ──────────────────────────────────────────
    %% SHARED IDENTITY LAYER
    %% ──────────────────────────────────────────

    class User {
        <<entity>>
        -id: UUID
        -email: String
        -passwordHash: String
        -firstName: String
        -lastName: String
        -phone: String
        -avatarUrl: String
        -isActive: Boolean
        -createdAt: DateTime
        -updatedAt: DateTime
        +deactivate() void
    }

    %% ──────────────────────────────────────────
    %% ADMIN PLATFORM
    %% ──────────────────────────────────────────

    class AdminUser {
        <<entity>>
        -id: UUID
        -userId: UUID
        -isSuperAdmin: Boolean
        -isActive: Boolean
        -createdAt: DateTime
        +assignRole(role: AdminRole) void
        +removeRole(role: AdminRole) void
        +getRoles() AdminRole[]
        +hasPermission(permissionCode: String) Boolean
        +getEffectivePermissions() PermissionSet
    }

    class AdminRole {
        <<entity>>
        -id: UUID
        -name: String
        -description: String
        -isActive: Boolean
        -createdAt: DateTime
        +addPermission(permission: AdminPermission) void
        +removePermission(permission: AdminPermission) void
        +getPermissions() AdminPermission[]
        +hasPermission(permissionCode: String) Boolean
    }

    class AdminPermission {
        <<entity>>
        %% Seeded by code — platform operations only
        %% e.g. admin.plans.create, admin.accounts.suspend
        %% NOT linked to ERP modules
        -id: UUID
        -code: String
        -name: String
        -description: String
        -action: String
        -resource: String
        +matches(action: String, resource: String) Boolean
    }

    %% ──────────────────────────────────────────
    %% MODULE & FEATURE REGISTRY
    %% Seeded by code at deploy time — immutable via API
    %% These are artifacts of the ERP codebase, not user-created data
    %% ──────────────────────────────────────────

    class Module {
        <<entity>>
        <<seeded>>
        -id: UUID
        -code: String
        -name: String
        -description: String
        -icon: String
        -isActive: Boolean
        -sortOrder: Int
        +getFeatures() Feature[]
        +getActiveFeatures() Feature[]
        +getPermissions() Permission[]
    }

    class Feature {
        <<entity>>
        <<seeded>>
        -id: UUID
        -moduleId: UUID
        -code: String
        -name: String
        -description: String
        -isActive: Boolean
        -sortOrder: Int
        +getPermissions() Permission[]
        +getModule() Module
    }

    class Permission {
        <<entity>>
        <<seeded>>
        %% Defined by ERP feature code — immutable.
        %% e.g. contacts.read, invoices.create, hr.employees.approve
        %% No Account creates or deletes Permissions — they only USE them via Roles.
        -id: UUID
        -featureId: UUID
        -code: String
        -name: String
        -description: String
        -action: String
        -resource: String
        +getFeature() Feature
        +getModule() Module
        +matches(action: String, resource: String) Boolean
    }

    %% ──────────────────────────────────────────
    %% PLAN SYSTEM
    %% Admin composes Plans from the Feature registry
    %% ──────────────────────────────────────────

    class Plan {
        <<entity>>
        -id: UUID
        -code: String
        -name: String
        -description: String
        -price: Decimal
        -billingCycle: String
        -maxCompanies: Int
        -maxMembers: Int
        -isActive: Boolean
        +getFeatures() Feature[]
        +getPermissionCeiling() PermissionSet
        +includesFeature(feature: Feature) Boolean
        +includesModule(module: Module) Boolean
        +getModules() Module[]
    }

    class PlanFeature {
        <<entity>>
        -id: UUID
        -planId: UUID
        -featureId: UUID
        -config: JSON
        +getFeature() Feature
        +getConfig() JSON
    }

    %% ──────────────────────────────────────────
    %% BILLING
    %% Subscription is the SINGLE source of truth for Account's active Plan.
    %% Account has NO plan_id field.
    %% ──────────────────────────────────────────

    class Subscription {
        <<entity>>
        -id: UUID
        -accountId: UUID
        -planId: UUID
        -status: SubscriptionStatus
        -currentPeriodStart: DateTime
        -currentPeriodEnd: DateTime
        -cancelledAt: DateTime
        +isActive() Boolean
        +isTrialing() Boolean
        +cancel() void
        +changePlan(newPlan: Plan) void
        +getActivePlan() Plan
    }

    class SubscriptionStatus {
        <<enumeration>>
        ACTIVE
        TRIALING
        PAST_DUE
        CANCELLED
    }

    %% ──────────────────────────────────────────
    %% CLIENT PLATFORM - ACCOUNT & ORGANIZATION
    %% ──────────────────────────────────────────

    class Account {
        <<entity>>
        %% No plan_id — plan is resolved via the active Subscription
        -id: UUID
        -ownerId: UUID
        -name: String
        -slug: String
        -isActive: Boolean
        -createdAt: DateTime
        +getOwner() User
        +getActiveSubscription() Subscription
        +getActivePlan() Plan
        +getCompanies() Company[]
        +getMembers() Member[]
        +getRoles() Role[]
        +getCollaborationsAsClient() Collaboration[]
        +getCollaborationsAsProvider() Collaboration[]
        +suspend() void
        +activate() void
    }

    class Company {
        <<entity>>
        -id: UUID
        -accountId: UUID
        -name: String
        -legalName: String
        -taxId: String
        -industry: String
        -country: String
        -address: String
        -logoUrl: String
        -isActive: Boolean
        +getAccount() Account
        +activateModule(module: Module) CompanyModule
        +deactivateModule(module: Module) void
        +getActiveModules() Module[]
        +hasModule(module: Module) Boolean
    }

    class CompanyModule {
        <<entity>>
        %% Can only activate Modules covered by the Account's active Plan
        -id: UUID
        -companyId: UUID
        -moduleId: UUID
        -isActive: Boolean
        -activatedAt: DateTime
        -deactivatedAt: DateTime
        +activate() void
        +deactivate() void
    }

    %% ──────────────────────────────────────────
    %% CLIENT PLATFORM - MEMBERS
    %% ──────────────────────────────────────────

    class Member {
        <<entity>>
        -id: UUID
        -userId: UUID
        -accountId: UUID
        -displayName: String
        -isOwner: Boolean
        -isActive: Boolean
        -joinedAt: DateTime
        +getUser() User
        +getAccount() Account
        +getRolesForCompany(company: Company) Role[]
        +getAccountWideRoles() Role[]
        +getAllRoles() Role[]
        +getAccessibleCompanies() Company[]
        +hasPermission(permissionCode: String, context: PermissionContext) Boolean
        +getEffectivePermissions(context: PermissionContext) PermissionSet
        +assignRole(role: Role, company: Company?) MemberRole
        +removeRole(role: Role, company: Company?) void
        +deactivate() void
    }

    %% ──────────────────────────────────────────
    %% CLIENT PLATFORM - ROLES
    %% ──────────────────────────────────────────

    class Role {
        <<entity>>
        %% Roles only contain Permissions whose Feature is in the Account's active Plan
        -id: UUID
        -accountId: UUID
        -name: String
        -description: String
        -isSystemRole: Boolean
        -isActive: Boolean
        +getPermissions() Permission[]
        +addPermission(permission: Permission) void
        +removePermission(permission: Permission) void
        +hasPermission(permissionCode: String) Boolean
        +getPermissionSet() PermissionSet
    }

    class RolePermission {
        <<entity>>
        -id: UUID
        -roleId: UUID
        -permissionId: UUID
        -grantedAt: DateTime
    }

    class MemberRole {
        <<entity>>
        %% company is nullable:
        %% null  = role applies account-wide (all companies)
        %% value = role applies to this specific company only
        -id: UUID
        -memberId: UUID
        -roleId: UUID
        -companyId: UUID?
        -assignedAt: DateTime
        +isAccountWide() Boolean
        +isCompanyScoped() Boolean
        +getScope() Company?
    }

    %% ──────────────────────────────────────────
    %% CLIENT PLATFORM - COLLABORATION
    %% ──────────────────────────────────────────

    class Collaboration {
        <<entity>>
        -id: UUID
        -clientAccountId: UUID
        -providerAccountId: UUID
        -companyId: UUID
        -status: CollaborationStatus
        -requestedAt: DateTime
        -acceptedAt: DateTime
        -revokedAt: DateTime
        +getClientAccount() Account
        +getProviderAccount() Account
        +getCompany() Company
        +getPermissionCeiling() PermissionSet
        +grantPermission(permission: Permission) void
        +revokePermission(permission: Permission) void
        +accept() void
        +suspend() void
        +revoke() void
        +isActive() Boolean
    }

    class CollaborationStatus {
        <<enumeration>>
        PENDING
        ACTIVE
        SUSPENDED
        REVOKED
    }

    class CollaborationPermission {
        <<entity>>
        %% Defines the ceiling for the provider account.
        %% Provider effective perms = role perms ∩ this ceiling ∩ active company modules
        -id: UUID
        -collaborationId: UUID
        -permissionId: UUID
        -grantedAt: DateTime
    }

    %% ============================================
    %% RELATIONSHIPS
    %% ============================================

    %% Interface implementations
    AdminUser ..|> IPermissionActor : implements
    Member ..|> IPermissionActor : implements

    %% Permission Engine
    PermissionEngine --> IPermissionActor : resolves for
    PermissionEngine --> PermissionContext : uses
    PermissionEngine --> PermissionSet : produces
    PermissionEngine --> Subscription : reads plan ceiling from
    PermissionContext --> ContextType : has
    PermissionContext --> TokenType : validated by

    %% Identity
    User "1" --> "0..1" AdminUser : can be
    User "1" --> "0..*" Member : identity of
    User "1" --> "0..1" Account : owns

    %% Admin Platform
    AdminUser "1" --> "0..*" AdminRole : has
    AdminRole "1" --> "0..*" AdminPermission : contains

    %% Module Registry (seeded — no owner)
    Module "1" --> "0..*" Feature : contains
    Feature "1" --> "0..*" Permission : defines

    %% Plan (admin composes from registry)
    Plan "1" --> "0..*" PlanFeature : includes
    PlanFeature "0..*" --> "1" Feature : references

    %% Billing (Subscription = source of truth for Account's plan)
    Account "1" --> "0..*" Subscription : billed via
    Subscription "0..*" --> "1" Plan : subscribes to
    Subscription --> SubscriptionStatus : has

    %% Account structure
    Account "1" --> "0..*" Company : contains
    Account "1" --> "0..*" Member : has
    Account "1" --> "0..*" Role : defines

    %% Company Modules (constrained to Plan)
    Company "1" --> "0..*" CompanyModule : activates
    CompanyModule "0..*" --> "1" Module : references

    %% Member Permissions
    Member "1" --> "0..*" MemberRole : assigned
    MemberRole "0..*" --> "1" Role : references
    MemberRole "0..*" --> "0..1" Company : scoped to
    Role "1" --> "0..*" RolePermission : contains
    RolePermission "0..*" --> "1" Permission : references

    %% Collaboration
    Account "1" --> "0..*" Collaboration : grants as client
    Account "1" --> "0..*" Collaboration : receives as provider
    Collaboration "0..*" --> "1" Company : shares
    Collaboration "1" --> "0..*" CollaborationPermission : defines ceiling
    Collaboration --> CollaborationStatus : has
    CollaborationPermission "0..*" --> "1" Permission : references
